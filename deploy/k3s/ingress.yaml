apiVersion: v1
kind: Secret
metadata:
  name: catalyst9-tls
  namespace: catalyst9
type: kubernetes.io/tls
data:
  # These will be replaced during deployment with actual cert content
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi4uLgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0t
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCi4uLgotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0t
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: catalyst9-ingress
  namespace: catalyst9
  annotations:
    # Traefik annotations for k3s
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: catalyst9-redirect@kubernetescrd
    # Rate limiting
    traefik.ingress.kubernetes.io/ratelimit.average: "100"
    traefik.ingress.kubernetes.io/ratelimit.burst: "200"
    # CORS
    traefik.ingress.kubernetes.io/cors.allowedOrigins: "https://catalyst9.ai,https://*.catalyst9.ai"
    traefik.ingress.kubernetes.io/cors.allowedMethods: "GET,POST,PUT,DELETE,OPTIONS"
    traefik.ingress.kubernetes.io/cors.allowedHeaders: "*"
    traefik.ingress.kubernetes.io/cors.allowCredentials: "true"
spec:
  tls:
  - hosts:
    - catalyst9.ai
    - api.catalyst9.ai
    - www.catalyst9.ai
    secretName: catalyst9-tls
  rules:
  # Main site
  - host: catalyst9.ai
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: catalyst9-api
            port:
              number: 80
  # API subdomain
  - host: api.catalyst9.ai
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: catalyst9-api
            port:
              number: 80
  # WWW redirect
  - host: www.catalyst9.ai
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: catalyst9-api
            port:
              number: 80
---
# Middleware for HTTP to HTTPS redirect
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: catalyst9-redirect
  namespace: catalyst9
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
# Middleware for rate limiting
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: catalyst9-ratelimit
  namespace: catalyst9
spec:
  rateLimit:
    average: 100
    burst: 200
    period: 1m
    sourceCriterion:
      ipStrategy:
        depth: 1
---
# Middleware for headers
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: catalyst9-headers
  namespace: catalyst9
spec:
  headers:
    customResponseHeaders:
      X-Frame-Options: "SAMEORIGIN"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"
    sslRedirect: true
    sslForceHost: true
    sslHost: catalyst9.ai
    referrerPolicy: "strict-origin-when-cross-origin"
    contentTypeNosniff: true
    browserXssFilter: true